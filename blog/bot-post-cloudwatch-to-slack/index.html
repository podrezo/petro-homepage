<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Petro Podrezo: Full-stack Software Developer"><meta name=author content="Petro Podrezo"><title>Petro Podrezo: Bot to post CloudWatch logs to a Slack channel using Ruby & AWS Lambda</title>
<link rel=icon type=image/svg+xml href=/braces.svg><link rel="alternate icon" ype=image/png href=/braces.png><link rel=stylesheet href=https://podrezo.com/root.min.b7eb11a9e907eb63a216dd77a1a7976117d18783ea07cb93cdd40d71e8a434c9.css></head><body><div class="container mt-5"><header class=mb-5><h1 class=title><img src=/braces.svg type=image/svg+xml> Petro Podrezo <small>Software Engineer</small></h1><nav class=mt-5><ul class="nav justify-content-center"><li class=nav-item><a class=nav-link href=https://podrezo.com/>Home</a></li><li class=nav-item><a class=nav-link href=https://podrezo.com/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://podrezo.com/mentorship/>Mentorship</a></li><li class=nav-item><a class=nav-link href=https://podrezo.com/projects/>Projects</a></li><li class=nav-item><a class=nav-link href=https://podrezo.com/contact/>Contact</a></li></ul></nav></header><nav aria-label=breadcrumb class="mt-2 breadcrumbnav"><ol class=breadcrumb><li class=breadcrumb-item><a href=https://podrezo.com/>Home</a></li><li class=breadcrumb-item><a href=https://podrezo.com/blog/>Blog</a></li><li class="breadcrumb-item active" aria-current=page>Bot to post CloudWatch logs to a Slack channel using Ruby & AWS Lambda</li></ol></nav><article class=row><div class=col-lg-12><h1 id=bot-to-post-cloudwatch-logs-to-a-slack-channel-using-ruby--aws-lambda>Bot to post CloudWatch logs to a Slack channel using Ruby & AWS Lambda</h1><p>We recently launched a new project at work that uses AWS’s “serverless” lambda functions and I wanted to see how simple it would be to leverage lambdas again to do some alerting around when our application encountered errors. When you print to standard output in a lambda (as is <a href=https://docs.aws.amazon.com/lambda/latest/dg/ruby-logging.html>the recommended way</a> of logging by Amazon), it goes directly into a configured CloudWatch log group which you can then add an event trigger to in order to run a separate “alerting” lambda function. I wanted to see what it would take to make that work together with Slack to post a message to a channel when an error condition was detected in our application. Turns out, there’s not much to it!</p><h3 id=setting-up-your-lambda>Setting up your Lambda</h3><p>I’m not going to walk you through the steps here because you just need a basic lambda function set up. If you want to follow along with my code in this article you’ll need to select Ruby as your runtime but you should be able to do the same thing any of the other runtimes. Since the data flow for this use-case is unidirectional, that is: we want events in CloudWatch to post a Slack message, we don’t need to configure an API gateway to hit the lambda at this time as would be typical for many other lambda use-cases.</p><p><p><img class="rounded mx-auto d-block img-thumbnail" src=aws-lambda-function-setup.png alt="AWS Lambda function configuration showing SlackBot with Ruby 2.5 runtime"></p></p><p>Function set up for AWS lambda</p><h3 id=setting-up-a-slack-bot>Setting up a Slack bot</h3><p>Go to the <a href=https://api.slack.com/apps>Slack API website</a> and click “create new app.” You will need the proper permissions to actually add the app into your slack group so if you’re just trying things out you may not want to add it to your real one and instead create a new one as a sandbox. Once you’ve created your bot, you can configure the various parameters on this website like its name and icon; I’m going to call mine “SmartBot”. Once done, head over to the “Incoming Webhooks” section and activate it. For the purposes of this example, we’re going to send to a single channel so go ahead and add a hook for it and take note of the resulting URL.</p><p><p><img class="rounded mx-auto d-block img-thumbnail" src=slack-webhook-configuration.png alt="Slack webhook URL configuration screen"></p></p><p>Slack webhook screen</p><h3 id=making-your-bot-talk-to-your-channel>Making your bot talk to your channel</h3><p>The first main piece of this puzzle is getting our bot to speak, which is as simple as issuing an HTTP request to the endpoint from the previous section. Let’s make SmartBot say “hello”.</p><p>To do this, take that URL for the slack hook from earlier and store it in an environment variable named “SLACK_HOOK_URL”. Paste the following code into your function, save it , and hit “test” — the body of the test event doesn’t matter for now so you can leave the example provided.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;json&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;net/https&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;uri&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>lambda_handler</span>(<span style=color:#e6db74>event</span>:, <span style=color:#e6db74>context</span>:)
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> speak(<span style=color:#e6db74>&#34;hello, slack!&#34;</span>)
</span></span><span style=display:flex><span>    puts response<span style=color:#f92672>.</span>body
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>speak</span>(message)
</span></span><span style=display:flex><span>    http <span style=color:#f92672>=</span> <span style=color:#66d9ef>Net</span><span style=color:#f92672>::</span><span style=color:#66d9ef>HTTP</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#34;hooks.slack.com&#34;</span>, <span style=color:#ae81ff>443</span>)
</span></span><span style=display:flex><span>    http<span style=color:#f92672>.</span>use_ssl <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    request <span style=color:#f92672>=</span> <span style=color:#66d9ef>Net</span><span style=color:#f92672>::</span><span style=color:#66d9ef>HTTP</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Post</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;SLACK_HOOK_URL&#34;</span><span style=color:#f92672>]</span>)
</span></span><span style=display:flex><span>    request<span style=color:#f92672>.</span>body <span style=color:#f92672>=</span> <span style=color:#66d9ef>JSON</span><span style=color:#f92672>.</span>generate({
</span></span><span style=display:flex><span>        <span style=color:#e6db74>text</span>: message
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    http<span style=color:#f92672>.</span>request(request)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>You should see something similar to the following in your slack channel:</p><p><p><img class="rounded mx-auto d-block img-thumbnail" src=smartbot-hello-message.png alt="SmartBot posting hello message to Slack channel"></p></p><p>SmartBot says hello</p><h3 id=responding-to-log-events>Responding to log events</h3><p>Now that we can speak, let’s make the bot speak in response to actual events we care about such when CloudWatch logs something in a specific log group. Add a trigger for “CloudWatch Logs” to your lambda and point it to the log group you’re interested such as the output of another lambda. For fun, you can just make a new lambda that does nothing but write a single line of output to the console.</p><p>This should be obvious but <strong>do NOT point it at the log group for the bot&rsquo;s own lambda</strong> as this will create a feedback loop where any event trigger will cause a runaway cyclical scenario and you&rsquo;ll probably burn through a very chunky portion of your AWS bill and probably be banned from Slack&rsquo;s API.</p><p><p><img class="rounded mx-auto d-block img-thumbnail" src=cloudwatch-logs-trigger-configuration.png alt="AWS Lambda trigger configuration for CloudWatch Logs"></p></p><p>At this point events from that log group should start triggering your lambda. The <a href=https://docs.aws.amazon.com/lambda/latest/dg/services-cloudwatchlogs.html>shape of the event is documented here</a>. Go ahead and add a new test event (or modify the existing one) with this example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;awslogs&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;data&#34;</span>: <span style=color:#e6db74>&#34;H4sIAAAAAAAAA2WQwY7CIBCGz/QpCPG4CS2rUffWxOplPcFNmw3qrJIUaIBqjfHdt5B6MDvH/5v5ZuCRIaLBe3kGcW+BfGGyKkX5s604LzcV+Ri4vRlwkfSvSnFjzxtnuzYSKm+eNlIfTpIK8GHdmWNQ1rwaeXAgdexkOctpzmgxo7vJdykqLuq+fzf77uCPTrXRsFZNAOeH0R3Z3pM7JaQe1dUVTEj8kSFE1Ont0n8VFyAS1PDoIHU8vpgtijlbTD+XU8YSHT8kirjVgL11AdtfPOb4Ag72hmToWWfPP09hdZtCAQAA&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As the documentation says, the “data” is a gzipped, base64 encoded JSON object that contains metadata and log messages. When you decode and decompress it, it has the following shape:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;messageType&#34;</span>: <span style=color:#e6db74>&#34;DATA_MESSAGE&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;owner&#34;</span>: <span style=color:#e6db74>&#34;xxxxxxxxx&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;logGroup&#34;</span>: <span style=color:#e6db74>&#34;/aws/lambda/TestFunction&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;logStream&#34;</span>: <span style=color:#e6db74>&#34;2020/02/15/[$LATEST]xxxxxxxxxxx&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;subscriptionFilters&#34;</span>: [<span style=color:#e6db74>&#34;MyTestFilter&#34;</span>],
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;logEvents&#34;</span>: [{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;timestamp&#34;</span>: <span style=color:#ae81ff>1581728439422</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;Some sort of message here\n&#34;</span>
</span></span><span style=display:flex><span> }]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So we’ll need a few more “requires” and to build a function to do the decoding and decompression. Moreover, we’ll want to add a function to process that JSON blob and extracts all the messages, ignoring all the other metadata (for our particular use case — you can obviously adjust it to suit your needs). Our code will now look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;json&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;net/https&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;uri&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;base64&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;zlib&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;stringio&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>lambda_handler</span>(<span style=color:#e6db74>event</span>:, <span style=color:#e6db74>context</span>:)
</span></span><span style=display:flex><span>  log_event <span style=color:#f92672>=</span> <span style=color:#66d9ef>JSON</span><span style=color:#f92672>.</span>parse(decode_and_decompress(event<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;awslogs&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>]</span>))
</span></span><span style=display:flex><span>  response <span style=color:#f92672>=</span> speak(messages_from_blob(log_event))
</span></span><span style=display:flex><span>  puts response<span style=color:#f92672>.</span>body
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>speak</span>(message)
</span></span><span style=display:flex><span>  http <span style=color:#f92672>=</span> <span style=color:#66d9ef>Net</span><span style=color:#f92672>::</span><span style=color:#66d9ef>HTTP</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#34;hooks.slack.com&#34;</span>, <span style=color:#ae81ff>443</span>)
</span></span><span style=display:flex><span>  http<span style=color:#f92672>.</span>use_ssl <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  request <span style=color:#f92672>=</span> <span style=color:#66d9ef>Net</span><span style=color:#f92672>::</span><span style=color:#66d9ef>HTTP</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Post</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;SLACK_HOOK_URL&#34;</span><span style=color:#f92672>]</span>)
</span></span><span style=display:flex><span>  request<span style=color:#f92672>.</span>body <span style=color:#f92672>=</span> <span style=color:#66d9ef>JSON</span><span style=color:#f92672>.</span>generate({
</span></span><span style=display:flex><span>    <span style=color:#e6db74>text</span>: message
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  http<span style=color:#f92672>.</span>request(request)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decode_and_decompress</span>(input)
</span></span><span style=display:flex><span>  binary_compressed <span style=color:#f92672>=</span> <span style=color:#66d9ef>Base64</span><span style=color:#f92672>.</span>decode64(input)
</span></span><span style=display:flex><span>  gz <span style=color:#f92672>=</span> <span style=color:#66d9ef>Zlib</span><span style=color:#f92672>::</span><span style=color:#66d9ef>GzipReader</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>StringIO</span><span style=color:#f92672>.</span>new(binary_compressed))
</span></span><span style=display:flex><span>  gz<span style=color:#f92672>.</span>read
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>messages_from_blob</span>(event_data)
</span></span><span style=display:flex><span>  event_data<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;logEvents&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>map{ <span style=color:#f92672>|</span>e<span style=color:#f92672>|</span> e<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;message&#34;</span><span style=color:#f92672>]</span> }
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>So what do we get when we run the test event?</p><p><p><img class="rounded mx-auto d-block img-thumbnail" src=smartbot-decoded-cloudwatch-message.png alt="SmartBot successfully posting decoded CloudWatch log message"></p></p><p>SmartBot has successfully decoded CloudWatch logs!</p><p>At this point you have the tools necessary to add any kind of filtering logic you may want and you’ll be able to do something a little smarter like respond to catastrophic failures in your lambda code by alerting your team automatically in Slack. Happy coding!</p></div></article><div class="item-grid mt-4"></div><div class="row footer mt-5 mb-5"><div class="col-lg-12 text-right text-muted">&copy; 2026 Petro Podrezo. Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a>.</div></div></div></body></html>